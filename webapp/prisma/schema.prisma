generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlite"
}

// ---------------------------------------------------------------------------
// Auth (NextAuth.js / Auth.js adapter tables)
// ---------------------------------------------------------------------------

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  passwordHash  String?
  image         String?
  role          String    @default("user") // user | admin | firm_admin | firm_member
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  accounts      Account[]
  sessions      Session[]
  credentials   UserCredential[]
  cpdRecords    CpdRecord[]
  evidence      Evidence[]
  onboarding    OnboardingSubmission?
  payments      Payment[]
  analyticsEvents AnalyticsEvent[]
  certificates  Certificate[]
  quizAttempts  QuizAttempt[]
  transcriptImports ExternalTranscriptImport[]
  ingestionAddress  IngestionAddress?

  // Firm membership
  firmId        String?
  firm          Firm?     @relation(fields: [firmId], references: [id])

  // Push notifications
  pushSubscription String?

  // Stripe
  stripeCustomerId String? @unique
  plan             String  @default("free") // free | setup | managed | firm
  planActivatedAt  DateTime?
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ---------------------------------------------------------------------------
// Credentials and Jurisdictions
// ---------------------------------------------------------------------------

model Credential {
  id              String   @id @default(cuid())
  name            String   @unique // e.g. "CFP", "CII/PFS", "NMC Nurse"
  body            String   // e.g. "CFP Board", "CII", "NMC"
  region          String   // e.g. "US", "GB", "AU", "INTL"
  vertical        String   // financial_services | health | engineering | legal | chartered_accounting
  hoursRequired   Float?   // annual or per-cycle requirement (null if competence-based)
  cycleLengthYears Int     @default(1) // 1 for annual, 2 for biennial, 3 for triennial
  ethicsHours     Float?   // mandatory ethics component
  structuredHours Float?   // mandatory structured/verifiable component
  description     String?
  categoryRules   String?  // JSON: category constraints, tags, special rules
  active          Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  userCredentials UserCredential[]
  rulePacks       CredentialRulePack[]
}

model UserCredential {
  id              String   @id @default(cuid())
  userId          String
  credentialId    String
  jurisdiction    String   // specific jurisdiction (e.g. state for US, country)
  renewalDeadline DateTime?
  hoursCompleted  Float    @default(0)
  isPrimary       Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  credential  Credential      @relation(fields: [credentialId], references: [id])
  allocations CpdAllocation[]

  @@unique([userId, credentialId])
}

// ---------------------------------------------------------------------------
// CPD Records and Evidence
// ---------------------------------------------------------------------------

model CpdRecord {
  id                String   @id @default(cuid())
  userId            String
  title             String
  provider          String?
  activityType      String   // structured | unstructured | participatory | verifiable | non-verifiable
  hours             Float
  date              DateTime
  status            String   @default("completed") // completed | in_progress | planned | upcoming
  category          String?  // ethics | technical | general | firm_element | etc.
  learningOutcome   String?
  notes             String?
  externalId        String?  // ID from external provider system
  source            String   @default("manual") // manual | auto | import | platform
  evidenceStrength  String   @default("manual_only") // manual_only | url_only | certificate_attached | provider_verified
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  evidence    Evidence[]
  allocations CpdAllocation[]

  @@index([userId, status])
  @@index([userId, date])
}

model Evidence {
  id                String   @id @default(cuid())
  userId            String
  cpdRecordId       String?
  fileName          String
  fileType          String   // pdf | image | text
  fileSize          Int
  storageKey        String   // S3 key or local path
  storageUrl        String?  // signed URL (generated on demand)
  metadata          String?  // JSON: extracted date, duration, learning outcome
  kind              String   @default("other") // certificate | transcript | agenda | screenshot | other
  status            String   @default("inbox") // inbox | assigned | deleted
  extractedMetadata String?  // JSON: AI/OCR extracted fields (title, provider, hours, date)
  uploadedAt        DateTime @default(now())

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  cpdRecord CpdRecord? @relation(fields: [cpdRecordId], references: [id])

  @@index([userId, status])
  @@index([cpdRecordId])
}

// ---------------------------------------------------------------------------
// Onboarding
// ---------------------------------------------------------------------------

model OnboardingSubmission {
  id                      String   @id @default(cuid())
  userId                  String   @unique
  fullName                String
  email                   String
  role                    String?
  primaryCredential       String?
  additionalCredentials   String?  // JSON array
  jurisdiction            String?
  renewalDeadline         String?
  currentHoursCompleted   String?
  preferredLearningFormat String?  // JSON array
  biggestPainPoint        String?
  status                  String   @default("pending") // pending | processing | complete
  submittedAt             DateTime @default(now())
  processedAt             DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ---------------------------------------------------------------------------
// Payments (Stripe)
// ---------------------------------------------------------------------------

model Payment {
  id                    String   @id @default(cuid())
  userId                String
  stripeSessionId       String?  @unique
  stripePaymentIntentId String?  @unique
  amount                Int      // in cents
  currency              String   @default("usd")
  status                String   @default("pending") // pending | succeeded | failed | refunded
  plan                  String   // setup | managed | firm
  interval              String?  // one_time | monthly | yearly
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ---------------------------------------------------------------------------
// Firms (B2B / White-Label)
// ---------------------------------------------------------------------------

model Firm {
  id              String   @id @default(cuid())
  name            String
  slug            String   @unique // URL-safe identifier
  domain          String?  // custom domain for white-label
  logoUrl         String?
  primaryColor    String?  // hex color for branding
  secondaryColor  String?
  plan            String   @default("firm") // firm | white_label
  seatsLimit      Int      @default(10)
  active          Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // White-label settings
  whiteLabel          Boolean @default(false)
  customBrandName     String? // e.g. "Zurich CPD Academy"
  certificateTemplate String? // JSON: template config for branded certificates
  customDomain        String? // e.g. cpd.zurich.co.uk
  webhookUrl          String? // endpoint for real-time usage data
  apiKey              String? @unique // for API access to analytics
  trackingIdPrefix    String? // e.g. "ZUR" for Zurich tracking IDs

  // Stripe
  stripeCustomerId    String? @unique
  stripeSubscriptionId String?

  // Relations
  members         User[]
  analyticsExports FirmAnalyticsExport[]
}

model FirmAnalyticsExport {
  id        String   @id @default(cuid())
  firmId    String
  exportType String  // daily_summary | weekly_report | monthly_report | ad_hoc
  data      String   // JSON: aggregated analytics data
  createdAt DateTime @default(now())

  firm Firm @relation(fields: [firmId], references: [id], onDelete: Cascade)
}

// ---------------------------------------------------------------------------
// Reminders
// ---------------------------------------------------------------------------

model Reminder {
  id          String   @id @default(cuid())
  userId      String
  type        String   // deadline | progress | custom
  title       String
  message     String?
  triggerDate DateTime
  channel     String   @default("email") // email | calendar | both
  status      String   @default("pending") // pending | sent | dismissed | failed
  credentialId String?
  metadata    String?  // JSON: extra config (recurrence, .ics data, etc.)
  createdAt   DateTime @default(now())
  sentAt      DateTime?

  @@index([userId, status])
  @@index([triggerDate, status])
}

// ---------------------------------------------------------------------------
// Certificates
// ---------------------------------------------------------------------------

model Certificate {
  id              String   @id @default(cuid())
  userId          String
  certificateCode String   @unique // e.g. "CERT-2026-abc123"
  title           String
  credentialName  String?
  hours           Float
  category        String?
  activityType    String?
  provider        String?
  completedDate   DateTime
  issuedDate      DateTime @default(now())
  verificationUrl String
  pdfStorageKey   String?
  metadata        String?  // JSON: extra data (quiz score, watch time, etc.)
  status          String   @default("active") // active | revoked
  cpdRecordId     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, issuedDate])
  @@index([certificateCode])
}

// ---------------------------------------------------------------------------
// Quizzes and Assessments
// ---------------------------------------------------------------------------

model Quiz {
  id           String   @id @default(cuid())
  title        String
  description  String?
  credentialId String?
  activityType String?  // what type of CPD this counts for
  passMark     Float    @default(70) // percentage needed to pass
  maxAttempts  Int      @default(3)
  timeLimit    Int?     // minutes, null = unlimited
  hours        Float    @default(0) // CPD hours awarded on pass
  category     String?  // ethics | technical | general
  questionsJson String  // JSON array of questions
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  attempts QuizAttempt[]
}

model QuizAttempt {
  id          String    @id @default(cuid())
  userId      String
  quizId      String
  answers     String    // JSON: user's answers
  score       Float     // percentage 0-100
  passed      Boolean
  startedAt   DateTime  @default(now())
  completedAt DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([userId, quizId])
  @@index([userId])
}

// ---------------------------------------------------------------------------
// Completion Rules
// ---------------------------------------------------------------------------

model CompletionRule {
  id           String   @id @default(cuid())
  name         String
  ruleType     String   // quiz_pass | watch_time | attendance | evidence_upload
  config       String   // JSON: { quizId, minScore, minWatchPercent, etc. }
  credentialId String?
  cpdRecordId  String?  // if rule is for a specific activity
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
}

// ---------------------------------------------------------------------------
// Activities & Content Catalog
// ---------------------------------------------------------------------------

model Activity {
  id              String   @id @default(cuid())
  tenantId        String?  // null = platform-owned; otherwise provider tenant
  type            String   // live_webinar | on_demand_video | article | assessment_only | bundle
  title           String
  description     String?
  presenters      String?  // JSON array of presenter names
  durationMinutes Int?     // declared duration
  learningObjectives String? // JSON array of learning objective strings
  tags            String?  // JSON array of topic/level tags
  jurisdictions   String?  // JSON array of jurisdiction codes (UK, AU, CA, US)
  evidencePolicy  String?  // JSON: { certificateRequired, reflectionRequired, quizRequired }
  deliveryUrl     String?  // URL for external content (YouTube, Vimeo, provider page)
  deliveryMeta    String?  // JSON: { platform, webinarId, occurrenceRules }
  publishStatus   String   @default("draft") // draft | review | published | archived
  version         Int      @default(1)
  createdBy       String?  // userId of creator
  approvedBy      String?  // userId of compliance approver
  publishedAt     DateTime?
  active          Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  creditMappings  CreditMapping[]
  quizId          String?  // optional linked quiz

  @@index([tenantId, publishStatus])
  @@index([type, active])
}

model CreditMapping {
  id              String   @id @default(cuid())
  activityId      String
  creditUnit      String   @default("hours") // hours | minutes | credits | points | PDH
  creditAmount    Float
  creditCategory  String   // ethics | professionalism | technical | practice_mgmt | general | other
  structuredFlag  String   @default("true") // true | false | conditional
  country         String   // UK | AU | CA | US | SG | HK | INTL
  stateProvince   String?  // JSON array of state/province codes (for US state-by-state)
  exclusions      String?  // JSON array of excluded states/provinces
  validationMethod String  @default("attendance") // attendance | quiz | reflection | attestation
  credentialId    String?  // optional: which specific credential this mapping applies to
  active          Boolean  @default(true)
  createdAt       DateTime @default(now())

  activity Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)

  @@index([activityId, country])
  @@index([credentialId])
}

// ---------------------------------------------------------------------------
// Rule Pack Versioning (PRD-004)
// ---------------------------------------------------------------------------

model CredentialRulePack {
  id            String    @id @default(cuid())
  credentialId  String
  version       Int       @default(1)
  name          String    // e.g. "CFP CE Rules 2026"
  rules         String    // JSON: { hoursRequired, ethicsHours, structuredHours, cycleLengthYears, categoryRules }
  effectiveFrom DateTime
  effectiveTo   DateTime? // null = currently active (no end date yet)
  changelog     String?   // description of what changed from previous version
  createdAt     DateTime  @default(now())

  credential Credential @relation(fields: [credentialId], references: [id])

  @@unique([credentialId, version])
  @@index([credentialId, effectiveFrom])
}

// ---------------------------------------------------------------------------
// Multi-Credential Allocation (PRD-005)
// ---------------------------------------------------------------------------

model CpdAllocation {
  id               String @id @default(cuid())
  cpdRecordId      String
  userCredentialId String
  hours            Float

  cpdRecord      CpdRecord      @relation(fields: [cpdRecordId], references: [id], onDelete: Cascade)
  userCredential UserCredential @relation(fields: [userCredentialId], references: [id], onDelete: Cascade)

  @@unique([cpdRecordId, userCredentialId])
  @@index([userCredentialId])
}

// ---------------------------------------------------------------------------
// Transcript Import Hub (PRD-002)
// ---------------------------------------------------------------------------

model ExternalTranscriptSource {
  id        String @id @default(cuid())
  code      String @unique  // FINPRO_IAR_CE, CFP_BOARD, SIRCON_CE, CE_BROKER, CME_PASSPORT, NABP_CPE
  name      String          // Human-readable name
  format    String @default("csv") // csv | pdf
  active    Boolean @default(true)
  createdAt DateTime @default(now())

  imports   ExternalTranscriptImport[]
}

model ExternalTranscriptImport {
  id          String    @id @default(cuid())
  userId      String
  sourceId    String
  evidenceId  String?   // optional link to uploaded evidence file
  status      String    @default("parsed") // uploaded | parsed | needs_review | imported | failed
  parsed      String    // JSON array of parsed entries
  mapping     String?   // JSON: user-selected credential/category mappings
  importedAt  DateTime?
  errorLog    String?   // JSON: any parsing errors
  createdAt   DateTime  @default(now())

  user   User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  source ExternalTranscriptSource @relation(fields: [sourceId], references: [id])

  @@index([userId, status])
}

// ---------------------------------------------------------------------------
// Email Forwarding Ingestion (PRD-006)
// ---------------------------------------------------------------------------

model IngestionAddress {
  id      String  @id @default(cuid())
  userId  String  @unique
  address String  @unique // e.g. user123@ingest.auditreadycpd.com
  active  Boolean @default(true)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ---------------------------------------------------------------------------
// Provider Verified Events (PRD-007)
// ---------------------------------------------------------------------------

model ProviderTenant {
  id          String  @id @default(cuid())
  name        String
  apiKeyHash  String  // bcrypt hash of API key
  contactEmail String?
  active      Boolean @default(true)
  createdAt   DateTime @default(now())

  events CompletionEvent[]
}

model CompletionEvent {
  id               String   @id @default(cuid())
  providerId       String
  userId           String?  // matched user (null if not yet matched)
  externalUserRef  String?  // provider's identifier for the user (email or ID)
  activityTitle    String
  hours            Float
  category         String?
  completedAt      DateTime
  payload          String   // JSON: full event data
  idempotencyKey   String   @unique
  status           String   @default("pending") // pending | matched | applied | failed
  cpdRecordId      String?  // created CPD record (after apply)
  createdAt        DateTime @default(now())

  provider ProviderTenant @relation(fields: [providerId], references: [id])

  @@index([providerId, createdAt])
  @@index([externalUserRef])
}

// ---------------------------------------------------------------------------
// Notifications
// ---------------------------------------------------------------------------

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String   // deadline_warning | evidence_match | import_complete | certificate_issued | plan_upgraded | general
  title     String
  message   String?
  link      String?  // optional deep link (e.g. /evidence, /dashboard)
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId, read])
  @@index([userId, createdAt])
}

// ---------------------------------------------------------------------------
// Firm Compliance Risk Scoring
// ---------------------------------------------------------------------------

model FirmComplianceSnapshot {
  id              String   @id @default(cuid())
  firmId          String
  snapshotDate    DateTime @default(now())
  totalMembers    Int
  compliantCount  Int
  atRiskCount     Int
  overdueCount    Int
  avgCompletionPct Float
  breakdown       String   // JSON: per-credential breakdown
  createdAt       DateTime @default(now())

  @@index([firmId, snapshotDate])
}

model FirmAlert {
  id         String    @id @default(cuid())
  firmId     String
  userId     String?   // the employee this alert is about
  type       String    // compliance_risk | deadline_approaching | member_overdue | milestone
  severity   String    // critical | high | medium | low
  title      String
  message    String
  read       Boolean   @default(false)
  resolvedAt DateTime?
  metadata   String?   // JSON: extra context
  createdAt  DateTime  @default(now())

  @@index([firmId, read])
  @@index([firmId, type])
}

// ---------------------------------------------------------------------------
// Usage Analytics
// ---------------------------------------------------------------------------

model AnalyticsEvent {
  id        String   @id @default(cuid())
  userId    String?
  sessionId String?  // anonymous session tracking
  firmId    String?  // which firm context (for white-label)
  event     String   // page_view | module_start | module_complete | certificate_issued | export | login | onboarding_step | quiz_attempt | quiz_pass
  page      String?  // URL or page identifier
  metadata  String?  // JSON: additional event data (module_id, quiz_score, etc.)
  trackingId String? // firm-specific tracking ID (e.g. ZUR-00123)
  userAgent String?
  ipHash    String?  // hashed IP for geo without PII
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
  @@index([firmId, createdAt])
  @@index([event, createdAt])
  @@index([trackingId])
}

// ---------------------------------------------------------------------------
// CPE/CPD Credit Marketplace
// ---------------------------------------------------------------------------

model MarketplaceListing {
  id                 String    @id @default(cuid())
  providerId         String    // userId of the provider
  title              String
  description        String?
  category           String    // ethics | technical | general | structured | unstructured
  activityType       String    // webinar | course | workshop | self_study | conference
  hours              Float     // CE hours awarded
  price              Float     @default(0) // 0 = free
  currency           String    @default("USD")
  credentialIds      String?   // JSON array of credential IDs this course applies to
  maxEnrollment      Int?      // null = unlimited
  startDate          DateTime?
  endDate            DateTime?
  enrollmentDeadline DateTime?
  status             String    @default("draft") // draft | published | archived | cancelled
  thumbnailUrl       String?
  syllabus           String?   // JSON: array of module titles
  tags               String?   // JSON array of tags
  featured           Boolean   @default(false)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  enrollments MarketplaceEnrollment[]

  @@index([status])
  @@index([category])
  @@index([providerId])
}

model MarketplaceEnrollment {
  id            String    @id @default(cuid())
  listingId     String
  userId        String
  status        String    @default("enrolled") // enrolled | in_progress | completed | cancelled | refunded
  enrolledAt    DateTime  @default(now())
  completedAt   DateTime?
  certificateId String?   // auto-generated certificate on completion
  cpdRecordId   String?   // auto-created CPD record on completion
  paymentId     String?   // link to payment if paid course
  metadata      String?   // JSON: progress, notes, etc.

  listing MarketplaceListing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@unique([listingId, userId])
  @@index([userId])
  @@index([listingId, status])
}

// ---------------------------------------------------------------------------
// Peer Benchmarking
// ---------------------------------------------------------------------------

model BenchmarkSnapshot {
  id                 String   @id @default(cuid())
  credentialId       String
  jurisdiction       String?
  period             String   // "2025-Q4", "2026-Q1", etc.
  totalUsers         Int
  avgHours           Float
  medianHours        Float
  p25Hours           Float    // 25th percentile
  p75Hours           Float    // 75th percentile
  p90Hours           Float    // 90th percentile
  avgEthicsHours     Float
  avgStructuredHours Float
  calculatedAt       DateTime @default(now())

  @@unique([credentialId, jurisdiction, period])
  @@index([credentialId])
}

// ---------------------------------------------------------------------------
// External API Keys
// ---------------------------------------------------------------------------

model ApiKey {
  id          String    @id @default(cuid())
  firmId      String
  name        String    // human-readable label
  keyHash     String    @unique // SHA-256 hash of the key
  keyPrefix   String    // first 8 chars for identification
  permissions String    // JSON array: ["read:employees", "read:compliance", "webhook:manage"]
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  revoked     Boolean   @default(false)
  createdAt   DateTime  @default(now())

  @@index([keyHash])
  @@index([firmId])
}

// ---------------------------------------------------------------------------
// Webhook Endpoints
// ---------------------------------------------------------------------------

model WebhookEndpoint {
  id           String    @id @default(cuid())
  firmId       String
  url          String
  events       String    // JSON array: ["compliance_changed", "deadline_approaching", "member_added"]
  secret       String    // HMAC signing secret
  active       Boolean   @default(true)
  lastDelivery DateTime?
  failCount    Int       @default(0)
  createdAt    DateTime  @default(now())

  @@index([firmId])
}
